<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Port Scanner & Server Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge{padding:.2rem .5rem;border-radius:9999px;font-size:.75rem}
    .badge-blue{background:#0a3d62;color:#4fc3f7;border:1px solid #4fc3f7}
    .badge-green{background:#1b5e20;color:#69f0ae;border:1px solid #69f0ae}
    .badge-gray{background:#37474f;color:#b0bec5;border:1px solid #b0bec5}
    .badge-purple{background:#4a148c;color:#ea80fc;border:1px solid #ea80fc}
    .badge-orange{background:#e65100;color:#ffd54f;border:1px solid #ffd54f}
    .spin{animation: spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
    .neon-glow{text-shadow:0 0 10px currentColor,0 0 20px currentColor,0 0 30px currentColor}
    .terminal-border{border:1px solid #00e5ff;box-shadow:0 0 15px #00e5ff}
    .field{display:flex;gap:.5rem;align-items:center}
    .label{min-width:9rem}
    .kbd{padding:.1rem .4rem;border:1px solid #777;border-radius:.25rem;font-size:.75rem}
  </style>
</head>
<body class="bg-black text-white min-h-screen font-mono">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="mb-6 text-center">
      <h1 class="text-4xl font-bold text-cyan-400 neon-glow mb-2">üöÄ PORT SCANNER & SERVER MANAGER</h1>
      <p class="text-green-400">Scan ports ‚Ä¢ Kill processes ‚Ä¢ Launch servers ‚Ä¢ Full control</p>
    </header>

    <!-- Settings -->
    <section class="bg-gray-900 rounded-xl terminal-border p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-cyan-300 font-semibold neon-glow">‚öôÔ∏è SETTINGS</div>
        <div class="text-xs text-gray-400">Tip: Press <span class="kbd">S</span> to focus the URL field quickly</div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="field">
          <label class="label text-cyan-400 text-sm">API Base URL</label>
          <input id="api-base" type="text" placeholder="http://127.0.0.1:5502" class="w-full p-2 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300" />
        </div>
        <div class="field">
          <label class="label text-cyan-400 text-sm">API Token</label>
          <input id="api-token" type="password" placeholder="(optional)" class="w-full p-2 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300" />
        </div>
        <div class="flex gap-2 items-end">
          <button id="btn-save-settings" class="w-full px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-lg hover:from-cyan-700 hover:to-blue-700">Save</button>
          <button id="btn-test" class="w-full px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg hover:from-green-700 hover:to-emerald-700">Test Connection</button>
        </div>
      </div>
      <p class="text-xs text-gray-400 mt-2">All requests send <code class="text-yellow-400">X-PSM-Token</code> when provided. Values persist in <code class="text-yellow-400">localStorage</code>.</p>
    </section>

    <!-- Error Display -->
    <div id="error" class="hidden mb-4 p-3 terminal-border bg-gray-900 text-red-400 rounded"></div>

    <!-- NEW: Batch File Generator Section -->
    <div class="bg-gray-900 rounded-xl terminal-border p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2 font-semibold text-purple-400 neon-glow">
          üìÅ GENERATE PROJECT .BAT FILE
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Project Name</label>
          <input type="text" id="project-name" placeholder="MyProject" 
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Project Type</label>
          <select id="project-type" class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
            <option value="static">Static Website</option>
            <option value="node">Node.js App</option>
            <option value="python">Python Flask</option>
            <option value="php">PHP Website</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4 mb-4">
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Project Directory</label>
          <input type="text" id="project-dir" 
                 value="C:\Users\Jo\OneDrive\Documents\Servidor de Pruebas de Proyectos\new"
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Port Number</label>
          <input type="number" id="project-port" placeholder="5000" value="5000"
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
        <div>
          <label class="block text-cyan-400 text-sm mb-2">HTML File Name</label>
          <input type="text" id="project-html" placeholder="index.html" value="index.html"
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
      </div>

      <!-- Features List -->
      <div class="bg-gray-800 p-4 rounded-lg mb-6">
        <h3 class="text-cyan-400 text-sm mb-2">Generated .bat will include:</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <div class="flex items-center gap-2">
            <span class="text-green-400">‚úì</span>
            <span>Auto server startup</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-green-400">‚úì</span>
            <span>Browser launch</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-green-400">‚úì</span>
            <span>Project structure creation</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-green-400">‚úì</span>
            <span>Package.json/requirements.txt</span>
          </div>
        </div>
      </div>

      <div class="flex gap-4">
        <button id="btn-cancel-batch" class="w-1/2 px-6 py-3 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-600 transition-all">
          CANCEL
        </button>
        <button id="btn-generate-batch" class="w-1/2 px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 text-white font-bold rounded-lg hover:from-purple-700 hover:to-cyan-700 transition-all">
          üì• DOWNLOAD .BAT FILE
        </button>
      </div>
    </div>

    <!-- Download Success Message -->
    <div id="download-success" class="hidden bg-green-900 rounded-xl terminal-border p-6 mb-6">
      <div class="flex items-center justify-between">
        <h3 class="text-green-400 font-semibold text-lg">‚úÖ BATCH FILE DOWNLOADED SUCCESSFULLY!</h3>
        <button id="btn-close-success" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-600">Close</button>
      </div>
      <div class="mt-4 text-sm text-cyan-400">
        <p>üìÅ File: <span id="download-filename" class="text-yellow-400">start_myproject.bat</span></p>
        <p>üìç Save it in your project directory and double-click to run!</p>
      </div>
    </div>

    <!-- Original Server Creation Section -->
    <div class="bg-gray-900 rounded-xl terminal-border p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2 font-semibold text-purple-400 neon-glow">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h16v6H4zM4 14h16v6H4z"/></svg>
          üöÄ LAUNCH NEW SERVER
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Server Name</label>
          <input type="text" id="server-name" placeholder="My Web Server" 
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Working Directory</label>
          <input type="text" id="server-cwd" placeholder="C:\\path\\to\\project" 
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Port Number</label>
          <input type="number" id="server-port" placeholder="3000" 
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
        <div>
          <label class="block text-cyan-400 text-sm mb-2">Server Type</label>
          <select id="server-template" class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
            <option value="py-http">Python HTTP Server</option>
            <option value="node-index">Node.js Server</option>
            <option value="gunicorn-app">Gunicorn App</option>
          </select>
        </div>
        <div>
          <label class="block text-cyan-400 text-sm mb-2">HTML File (Optional)</label>
          <input type="text" id="server-html" placeholder="index.html" 
                 class="w-full p-3 bg-gray-800 border border-cyan-500 text-white rounded-lg focus:outline-none focus:border-cyan-300">
        </div>
      </div>

      <button id="btn-launch" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 text-white font-bold rounded-lg hover:from-purple-700 hover:to-cyan-700 transition-all">
        üöÄ LAUNCH SERVER
      </button>
    </div>

    <!-- Main Port Scanner Section -->
    <div class="bg-gray-900 rounded-xl terminal-border">
      <div class="flex items-center justify-between px-6 py-4 border-b border-cyan-800">
        <div class="flex items-center gap-2 font-semibold text-green-400 neon-glow">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h16v6H4zM4 14h16v6H4z"/></svg>
          üîç ACTIVE PORTS & SERVERS
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-scan" class="px-6 py-2 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:from-green-700 hover:to-blue-700 transition-all">SCAN PORTS</button>
          <span id="scan-spinner" class="hidden spin text-cyan-400">üîÑ</span>
        </div>
      </div>

      <!-- Stats -->
      <div class="px-6 py-3 text-sm grid grid-cols-2 md:grid-cols-5 gap-4 border-b border-cyan-800">
        <div class="text-cyan-400">TCP: <span id="stat-tcp" class="font-semibold text-white">0</span></div>
        <div class="text-cyan-400">UDP: <span id="stat-udp" class="font-semibold text-white">0</span></div>
        <div class="text-cyan-400">Total: <span id="stat-total" class="font-semibold text-white">0</span></div>
        <div class="text-cyan-400">Servers: <span id="stat-servers" class="font-semibold text-white">0</span></div>
        <div class="text-cyan-400">Updated: <span id="stat-time" class="font-mono text-yellow-400">‚Äî</span></div>
      </div>

      <!-- Empty State -->
      <div id="empty" class="text-center py-12 hidden">
        <div class="text-yellow-400 text-5xl mb-2">‚ö†Ô∏è</div>
        <h3 class="text-lg font-medium text-white mb-2">No active ports found</h3>
        <p class="text-gray-400">Click "SCAN PORTS" to discover active network connections</p>
      </div>

      <!-- Tables -->
      <div id="table-wrap" class="overflow-x-auto hidden">
        <!-- Ports Table -->
        <div class="border-b border-cyan-800">
          <h3 class="px-6 py-3 text-orange-400 font-semibold neon-glow">üì° ACTIVE PORTS</h3>
          <table class="w-full text-sm">
            <thead class="bg-gray-800 text-cyan-400">
              <tr>
                <th class="text-left p-3">Port</th>
                <th class="text-left p-3">Protocol</th>
                <th class="text-left p-3">Status</th>
                <th class="text-left p-3">Service</th>
                <th class="text-left p-3">Process</th>
                <th class="text-right p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <!-- Servers Table -->
        <div>
          <h3 class="px-6 py-3 text-purple-400 font-semibold neon-glow">üñ•Ô∏è LAUNCHED SERVERS</h3>
          <table class="w-full text-sm">
            <thead class="bg-gray-800 text-purple-400">
              <tr>
                <th class="text-left p-3">Name</th>
                <th class="text-left p-3">Port</th>
                <th class="text-left p-3">Type</th>
                <th class="text-left p-3">PID</th>
                <th class="text-left p-3">Status</th>
                <th class="text-right p-3">Actions</th>
              </tr>
            </thead>
            <tbody id="server-rows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Kill Modal -->
    <div id="modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50">
      <div class="bg-gray-900 rounded-lg terminal-border w-full max-w-md">
        <div class="flex justify-between items-center border-b border-cyan-800 p-4">
          <h3 class="text-lg font-semibold text-red-400 neon-glow">‚ö†Ô∏è CONFIRM TERMINATION</h3>
          <button id="modal-close" class="p-1 hover:bg-gray-800 rounded text-white">‚úñ</button>
        </div>
        <div class="p-4 text-sm">
          <p class="text-white mb-4">Terminate process using port <strong id="m-port" class="text-yellow-400">‚Äî</strong>?</p>
          <div class="bg-gray-800 p-3 rounded border border-cyan-800 text-white">
            <div>Service: <span id="m-service" class="font-medium text-cyan-400">‚Äî</span></div>
            <div>Process: <span id="m-proc" class="font-medium text-cyan-400">‚Äî</span></div>
            <div>PID: <span id="m-pid" class="font-mono text-green-400">‚Äî</span></div>
          </div>
          <div class="bg-yellow-900 border-l-4 border-yellow-500 p-3 mt-3 text-yellow-200">
            ‚ö†Ô∏è <b>Warning:</b> This may affect running applications. Run as Administrator.
          </div>
        </div>
        <div class="flex justify-end gap-2 p-4 border-t border-cyan-800">
          <button id="modal-cancel" class="px-4 py-2 rounded border border-gray-600 text-white hover:bg-gray-800">CANCEL</button>
          <button id="modal-confirm" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">TERMINATE</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-6 text-xs text-center text-gray-500">
      Port Scanner & Server Manager ‚Ä¢ Backend: <code class="text-red-400">server.py</code> ‚Ä¢ Run with Admin privileges for full functionality
    </div>
  </div>

  <!-- Single, unified script -->
  <script>
    // ------------- Settings-backed API client (no duplicates / no nested <script>) -------------
    const errBox = document.getElementById("error");
    function showError(msg){ errBox.textContent = msg; errBox.classList.remove("hidden"); }
    function clearError(){ errBox.classList.add("hidden"); errBox.textContent = ""; }

    const Settings = {
      get base(){ return localStorage.getItem('PSM_API_BASE') || 'http://127.0.0.1:5502'; },
      set base(v){ localStorage.setItem('PSM_API_BASE', v); },
      get token(){ return localStorage.getItem('PSM_API_TOKEN') || (new URLSearchParams(location.search).get('token') || ''); },
      set token(v){ localStorage.setItem('PSM_API_TOKEN', v); }
    };

    async function apiFetch(path, {method='GET', headers={}, body, timeoutMs=10000} = {}) {
      const base = Settings.base.replace(/\/$/, '');
      const url = (typeof path === 'string' && path.startsWith('http')) ? path : (base + path);
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(new DOMException('timeout','AbortError')), timeoutMs);

      try {
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            ...(Settings.token ? {'X-PSM-Token': Settings.token} : {}),
            ...headers
          },
          body,
          signal: controller.signal
        });
        const raw = await res.text();
        let data = raw ? JSON.parse(raw) : {};
        if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status} ‚Äî ${raw}`);
        return data;
      } catch (e) {
        if (e.name === 'AbortError') throw new Error(`Request timeout after ${Math.round(timeoutMs/1000)}s`);
        throw e;
      } finally { clearTimeout(timeout); }
    }

    // ------------- Wire settings UI -------------
    const inputBase = document.getElementById('api-base');
    const inputToken = document.getElementById('api-token');
    const btnSave = document.getElementById('btn-save-settings');
    const btnTest = document.getElementById('btn-test');

    inputBase.value = Settings.base;
    inputToken.value = Settings.token;

    btnSave.onclick = () => {
      Settings.base = inputBase.value.trim();
      Settings.token = inputToken.value;
      clearError();
      showError(`‚úÖ Saved. Base: ${Settings.base}${Settings.token ? " ¬∑ Token set" : ""}`);
      setTimeout(clearError, 2000);
    };

    btnTest.onclick = async () => {
      clearError();
      try {
        const health = await apiFetch('/health').catch(() => null); // optional
        // If no /health route, ping something cheap:
        const info = health || await apiFetch('/api/servers/list').catch(()=>({ok:true, servers:[]}));
        showError(`‚úÖ Connected to ${Settings.base}`);
        setTimeout(clearError, 2000);
      } catch (e) {
        showError(`‚ùå Cannot reach ${Settings.base}: ${e.message}`);
      }
    };

    window.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 's' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) {
        inputBase.focus();
        inputBase.select();
        e.preventDefault();
      }
    });

    // ------------- DOM elements -------------
    const btnScan = document.getElementById("btn-scan");
    const btnLaunch = document.getElementById("btn-launch");
    const spin = document.getElementById("scan-spinner");
    const rows = document.getElementById("rows");
    const serverRows = document.getElementById("server-rows");
    const empty = document.getElementById("empty");
    const wrap = document.getElementById("table-wrap");

    const statTCP = document.getElementById("stat-tcp");
    const statUDP = document.getElementById("stat-udp");
    const statTotal = document.getElementById("stat-total");
    const statServers = document.getElementById("stat-servers");
    const statTime = document.getElementById("stat-time");

    const serverName = document.getElementById("server-name");
    const serverCwd = document.getElementById("server-cwd");
    const serverPort = document.getElementById("server-port");
    const serverTemplate = document.getElementById("server-template");
    const serverHtml = document.getElementById("server-html");

    const modal = document.getElementById("modal");
    const mPort = document.getElementById("m-port");
    const mService = document.getElementById("m-service");
    const mProc = document.getElementById("m-proc");
    const mPid = document.getElementById("m-pid");
    const btnModalCancel = document.getElementById("modal-cancel");
    const btnModalClose = document.getElementById("modal-close");
    const btnModalConfirm = document.getElementById("modal-confirm");
    let modalData = null;

    // ------------- Batch File Generator Elements -------------
    const projectName = document.getElementById('project-name');
    const projectType = document.getElementById('project-type');
    const projectDir = document.getElementById('project-dir');
    const projectPort = document.getElementById('project-port');
    const projectHtml = document.getElementById('project-html');
    const btnGenerateBatch = document.getElementById('btn-generate-batch');
    const btnCancelBatch = document.getElementById('btn-cancel-batch');
    const downloadSuccess = document.getElementById('download-success');
    const downloadFilename = document.getElementById('download-filename');
    const btnCloseSuccess = document.getElementById('btn-close-success');

    // Batch file templates for different project types
    const batchTemplates = {
      static: (name, dir, port, htmlFile) => `@echo off
chcp 65001 >nul
title ${name} - Static Website
echo ===============================
echo    Starting ${name}
echo ===============================
echo.

REM Create project directory
if not exist "${dir}" mkdir "${dir}"
cd /d "${dir}"

REM Create proper HTML structure with CSS and JS
echo ^<!DOCTYPE html^> > ${htmlFile}
echo ^<html lang="en"^> >> ${htmlFile}
echo ^<head^> >> ${htmlFile}
echo   ^<meta charset="UTF-8"^> >> ${htmlFile}
echo   ^<meta name="viewport" content="width=device-width, initial-scale=1.0"^> >> ${htmlFile}
echo   ^<title^>${name}^</title^> >> ${htmlFile}
echo   ^<style^> >> ${htmlFile}
echo     body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: white; } >> ${htmlFile}
echo     .container { max-width: 800px; margin: 0 auto; } >> ${htmlFile}
echo   ^</style^> >> ${htmlFile}
echo ^</head^> >> ${htmlFile}
echo ^<body^> >> ${htmlFile}
echo   ^<div class="container"^> >> ${htmlFile}
echo     ^<h1^>üöÄ Welcome to ${name}^</h1^> >> ${htmlFile}
echo     ^<p^>Your static website is running successfully!^</p^> >> ${htmlFile}
echo     ^<p^>Server: http://localhost:${port}^</p^> >> ${htmlFile}
echo   ^</div^> >> ${htmlFile}
echo ^<script^> >> ${htmlFile}
echo   console.log('${name} is running on port ${port}'); >> ${htmlFile}
echo ^</script^> >> ${htmlFile}
echo ^</html^> >> ${htmlFile}

REM Create CSS directory and basic styles
if not exist "css" mkdir "css"
echo body { font-family: Arial, sans-serif; } > css/style.css
echo .header { background: #007acc; color: white; padding: 20px; } >> css/style.css

REM Create JS directory and basic scripts
if not exist "js" mkdir "js"
echo console.log('${name} JavaScript loaded'); > js/script.js

echo.
echo Project structure created!
echo Starting web server on port ${port}...
timeout /t 2 /nobreak >nul

REM Start Python HTTP server
start "Web Server" python -m http.server ${port}

echo Opening browser...
timeout /t 3 /nobreak >nul
start "" "http://localhost:${port}"

echo.
echo ‚úÖ ${name} is ready and running!
echo üìç http://localhost:${port}
echo.
pause`,

      node: (name, dir, port, htmlFile) => `@echo off
chcp 65001 >nul
title ${name} - Node.js App
echo ===============================
echo    Starting ${name}
echo ===============================
echo.

REM Create project directory
if not exist "${dir}" mkdir "${dir}"
cd /d "${dir}"

REM Create package.json
echo { > package.json
echo   "name": "${name.toLowerCase()}", >> package.json
echo   "version": "1.0.0", >> package.json
echo   "description": "${name} - Node.js Application", >> package.json
echo   "main": "server.js", >> package.json
echo   "scripts": { >> package.json
echo     "start": "node server.js", >> package.json
echo     "dev": "node server.js" >> package.json
echo   }, >> package.json
echo   "dependencies": { >> package.json
echo     "express": "^4.18.0" >> package.json
echo   } >> package.json
echo } >> package.json

REM Create Node.js server file
echo const express = require('express'); > server.js
echo const app = express(); >> server.js
echo const PORT = ${port}; >> server.js
echo. >> server.js
echo app.use(express.static('public')); >> server.js
echo. >> server.js
echo app.get('/', (req, res) => { >> server.js
echo   res.send(\` >> server.js
echo     ^<!DOCTYPE html^> >> server.js
echo     ^<html^> >> server.js
echo       ^<head^> >> server.js
echo         ^<title^>${name}^</title^> >> server.js
echo         ^<style^> >> server.js
echo           body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: white; } >> server.js
echo         ^</style^> >> server.js
echo       ^</head^> >> server.js
echo       ^<body^> >> server.js
echo         ^<h1^>üöÄ ${name} - Node.js App^</h1^> >> server.js
echo         ^<p^>Running on Express server!^</p^> >> server.js
echo         ^<p^>Port: \${PORT}^</p^> >> server.js
echo       ^</body^> >> server.js
echo     ^</html^> >> server.js
echo   \`); >> server.js
echo }); >> server.js
echo. >> server.js
echo app.listen(PORT, () => { >> server.js
echo   console.log(\`${name} running on http://localhost:\${PORT}\`); >> server.js
echo }); >> server.js

REM Create public directory for static files
if not exist "public" mkdir "public"
echo ^<!DOCTYPE html^> > public/index.html
echo ^<html^>^<body^>^<h1^>Static Files Folder^</h1^>^</body^>^</html^> >> public/index.html

echo.
echo Installing dependencies...
call npm install

echo.
echo Starting Node.js server...
timeout /t 2 /nobreak >nul

start "Node Server" node server.js

echo Opening browser...
timeout /t 3 /nobreak >nul
start "" "http://localhost:${port}"

echo.
echo ‚úÖ ${name} Node.js app is ready!
echo üìç http://localhost:${port}
echo.
pause`,

      python: (name, dir, port, htmlFile) => `@echo off
chcp 65001 >nul
title ${name} - Python Flask App
echo ===============================
echo    Starting ${name}
echo ===============================
echo.

REM Create project directory
if not exist "${dir}" mkdir "${dir}"
cd /d "${dir}"

REM Create requirements.txt
echo Flask^>^=2.3.0 > requirements.txt

REM Create Python Flask app
echo from flask import Flask, render_template > app.py
echo. >> app.py
echo app = Flask(__name__) >> app.py
echo. >> app.py
echo @app.route('/') >> app.py
echo def home(): >> app.py
echo     return render_template('index.html', name='${name}', port=${port}) >> app.py
echo. >> app.py
echo if __name__ == '__main__': >> app.py
echo     app.run(debug=True, port=${port}) >> app.py

REM Create templates directory
if not exist "templates" mkdir "templates"

REM Create HTML template
echo ^<!DOCTYPE html^> > templates/index.html
echo ^<html^> >> templates/index.html
echo ^<head^> >> templates/index.html
echo   ^<title^>{{ name }}^</title^> >> templates/index.html
echo   ^<style^> >> templates/index.html
echo     body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: white; } >> templates/index.html
echo   ^</style^> >> templates/index.html
echo ^</head^> >> templates/index.html
echo ^<body^> >> templates/index.html
echo   ^<h1^>üöÄ {{ name }} - Flask App^</h1^> >> templates/index.html
echo   ^<p^>Running on Python Flask!^</p^> >> templates/index.html
echo   ^<p^>Port: {{ port }}^</p^> >> templates/index.html
echo ^</body^> >> templates/index.html
echo ^</html^> >> templates/index.html

echo.
echo Installing Flask...
pip install flask

echo.
echo Starting Flask server...
timeout /t 2 /nobreak >nul

start "Flask Server" python app.py

echo Opening browser...
timeout /t 3 /nobreak >nul
start "" "http://localhost:${port}"

echo.
echo ‚úÖ ${name} Flask app is ready!
echo üìç http://localhost:${port}
echo.
pause`,

      php: (name, dir, port, htmlFile) => `@echo off
chcp 65001 >nul
title ${name} - PHP Website
echo ===============================
echo    Starting ${name}
echo ===============================
echo.

REM Create project directory
if not exist "${dir}" mkdir "${dir}"
cd /d "${dir}"

REM Create PHP index file
echo ^<!DOCTYPE html^> > index.php
echo ^<html^> >> index.php
echo ^<head^> >> index.php
echo   ^<title^>${name}^</title^> >> index.php
echo   ^<style^> >> index.php
echo     body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: white; } >> index.php
echo   ^</style^> >> index.php
echo ^</head^> >> index.php
echo ^<body^> >> index.php
echo   ^<h1^>üöÄ ${name} - PHP Website^</h1^> >> index.php
echo   ^<p^>Server: http://localhost:${port}^</p^> >> index.php
echo   ^<?php >> index.php
echo     echo "^<p^>PHP is working! Server time: " . date('Y-m-d H:i:s') . "^</p^>"; >> index.php
echo   ?^> >> index.php
echo ^</body^> >> index.php
echo ^</html^> >> index.php

echo.
echo Starting PHP built-in server...
timeout /t 2 /nobreak >nul

start "PHP Server" php -S localhost:${port}

echo Opening browser...
timeout /t 3 /nobreak >nul
start "" "http://localhost:${port}"

echo.
echo ‚úÖ ${name} PHP website is ready!
echo üìç http://localhost:${port}
echo.
pause`
    };

    // ------------- Batch File Generator Functions -------------
    function downloadBatchFile(content, filename) {
      const blob = new Blob([content], { type: 'application/bat' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    btnGenerateBatch.addEventListener('click', function() {
      const name = projectName.value.trim() || 'MyProject';
      const type = projectType.value;
      const dir = projectDir.value.trim();
      const port = projectPort.value || '5000';
      const htmlFile = projectHtml.value.trim() || 'index.html';

      if (!dir) {
        showError('Please specify a project directory');
        return;
      }

      // Generate the batch file content
      const batchCode = batchTemplates[type](name, dir, port, htmlFile);
      const filename = `start_${name.replace(/\s+/g, '_').toLowerCase()}.bat`;
      
      // Download the batch file
      downloadBatchFile(batchCode, filename);
      
      // Show success message
      downloadFilename.textContent = filename;
      downloadSuccess.classList.remove('hidden');
      clearError();
    });

    // Close success message
    btnCloseSuccess.addEventListener('click', function() {
      downloadSuccess.classList.add('hidden');
    });

    // Cancel button
    btnCancelBatch.addEventListener('click', function() {
      projectName.value = '';
      projectPort.value = '5000';
      projectHtml.value = 'index.html';
      downloadSuccess.classList.add('hidden');
      clearError();
    });

    // ------------- Original Port Scanner Functions -------------
    function badge(status){
      if(status === "listening") return '<span class="badge badge-green">LISTENING</span>';
      if(status === "open") return '<span class="badge badge-blue">OPEN</span>';
      if(status === "running") return '<span class="badge badge-purple">RUNNING</span>';
      if(status === "stopped") return '<span class="badge badge-orange">STOPPED</span>';
      return '<span class="badge badge-gray">CLOSED</span>';
    }

    function render(ports, servers = []){
      rows.innerHTML = "";
      serverRows.innerHTML = "";
      let tcp=0, udp=0;

      if (ports && ports.length > 0) {
        for (const p of ports) {
          if(p.protocol === "TCP") tcp++; else if(p.protocol === "UDP") udp++;
          const proc = p.processName ? `${p.processName}${p.pid ? " (PID "+p.pid+")":""}` : "‚Äî";
          const canKill = !!p.pid && p.pid !== 4;
          const tr = document.createElement("tr");
          tr.className = "border-t border-cyan-800 hover:bg-gray-800";
          tr.innerHTML = `
            <td class="p-3 font-medium text-yellow-400">${p.port}</td>
            <td class="p-3 text-cyan-400">${p.protocol}</td>
            <td class="p-3">${badge(p.status)}</td>
            <td class="p-3 text-green-400">${p.service || "Unknown"}</td>
            <td class="p-3 text-white">${proc}</td>
            <td class="p-3 text-right">
              <button data-port="${p.port}" data-proto="${p.protocol}" data-pid="${p.pid||""}" data-service="${p.service||""}" data-proc="${p.processName||""}"
                class="px-3 py-1.5 rounded border border-red-500 text-red-400 hover:bg-red-900 hover:text-white transition-all ${canKill?"":"opacity-40 cursor-not-allowed"}"
                ${canKill? "":"disabled"}>TERMINATE</button>
            </td>`;
          rows.appendChild(tr);
        }

        rows.querySelectorAll("button[data-pid]").forEach(btn=>{
          btn.onclick = () => {
            const pid = Number(btn.dataset.pid||"");
            modalData = {
              port: Number(btn.dataset.port),
              protocol: btn.dataset.proto,
              pid,
              service: btn.dataset.service || "Unknown",
              processName: btn.dataset.proc || "Unknown"
            };
            mPort.textContent = `${modalData.port}/${modalData.protocol}`;
            mService.textContent = modalData.service;
            mProc.textContent = modalData.processName;
            mPid.textContent = modalData.pid || "‚Äî";
            modal.classList.remove("hidden");
          };
        });
      }

      if (servers && servers.length > 0) {
        for (const s of servers) {
          const tr = document.createElement("tr");
          tr.className = "border-t border-cyan-800 hover:bg-gray-800";
          tr.innerHTML = `
            <td class="p-3 font-medium text-purple-400">${s.name}</td>
            <td class="p-3 text-yellow-400">${s.port}</td>
            <td class="p-3 text-cyan-400">${s.template}</td>
            <td class="p-3 text-green-400">${s.pid}</td>
            <td class="p-3">${badge('running')}</td>
            <td class="p-3 text-right">
              <button data-id="${s.id}" data-pid="${s.pid}"
                class="px-3 py-1.5 rounded border border-orange-500 text-orange-400 hover:bg-orange-900 hover:text-white transition-all">
                STOP SERVER
              </button>
            </td>`;
          serverRows.appendChild(tr);
        }

        serverRows.querySelectorAll("button[data-id]").forEach(btn=>{
          btn.onclick = async () => {
            const serverId = btn.dataset.id;
            const pid = btn.dataset.pid;
            if(confirm(`Stop server ${pid}?`)) {
              try {
                const data = await apiFetch("/api/servers/stop", {
                  method: "POST",
                  body: JSON.stringify({ id: serverId })
                });
                if(data.ok) await scan();
              } catch(e) {
                showError("Stop server error: " + e.message);
              }
            }
          };
        });
      }

      statTCP.textContent = tcp;
      statUDP.textContent = udp;
      statTotal.textContent = ports ? ports.length : 0;
      statServers.textContent = servers ? servers.length : 0;
      statTime.textContent = new Date().toLocaleTimeString();

      empty.classList.toggle("hidden", ports && ports.length !== 0);
      wrap.classList.toggle("hidden", !ports || ports.length === 0);
    }

    async function scan(){
      try{
        clearError();
        btnScan.disabled = true; 
        spin.classList.remove("hidden");

        const portsData = await apiFetch("/api/ports/scan");
        const serversData = await apiFetch("/api/servers/list").catch(()=>({ok:true, servers:[]}));
        render(portsData.ports || [], serversData.servers || []);

      } catch(e) {
        console.error("Scan error:", e);
        showError("Scan error: " + e.message);
        empty.classList.remove("hidden");
        wrap.classList.add("hidden");
      } finally {
        btnScan.disabled = false; 
        spin.classList.add("hidden");
      }
    }

    async function launchServer(){
      try {
        clearError();
        const name = serverName.value.trim();
        const cwd = serverCwd.value.trim();
        const port = serverPort.value ? parseInt(serverPort.value) : null;
        const template = serverTemplate.value;
        const htmlFile = serverHtml.value.trim();

        if(!name) return showError("Server name is required");
        if(!cwd) return showError("Working directory is required");

        btnLaunch.disabled = true;
        btnLaunch.textContent = "LAUNCHING...";

        const data = await apiFetch("/api/servers/launch", {
          method: "POST",
          body: JSON.stringify({ name, template, port, cwd, htmlFile })
        });

        if(!data.ok) throw new Error(data.error || "Launch failed");

        // Clear form
        serverName.value = "";
        serverCwd.value = "";
        serverPort.value = "";
        serverHtml.value = "";

        showError("‚úÖ Server launched successfully!");
        await scan();

      } catch(e) {
        showError("Launch error: " + e.message);
      } finally {
        btnLaunch.disabled = false;
        btnLaunch.textContent = "üöÄ LAUNCH SERVER";
      }
    }

    async function killPID(pid){
      return apiFetch("/api/ports/kill", {
        method: "POST",
        body: JSON.stringify({ pid })
      });
    }

    // Event listeners
    btnScan.onclick = scan;
    btnLaunch.onclick = launchServer;

    btnModalCancel.onclick = () => { modal.classList.add("hidden"); };
    btnModalClose.onclick = btnModalCancel.onclick;

    btnModalConfirm.onclick = async () => {
      if(!modalData?.pid){ btnModalCancel.onclick(); return; }
      btnModalConfirm.disabled = true; 
      btnModalConfirm.textContent = "TERMINATING‚Ä¶";
      try{
        const data = await killPID(modalData.pid);
        if(!data.ok) throw new Error(data.error || "Termination failed");
        await scan();
      } catch(e) {
        showError("Termination error: " + e.message);
      } finally {
        btnModalConfirm.disabled = false; 
        btnModalConfirm.textContent = "TERMINATE";
        btnModalCancel.onclick();
      }
    };

    // Default working directory suggestion (non-destructive)
    try {
      const parts = window.location.pathname.split('/').slice(0,-1).join('/');
      serverCwd.value = parts || "C:\\";
    } catch { serverCwd.value = "C:\\"; }

    // Initial scan is gated behind a quick connection test so we don't time out noisily
    (async () => {
      try {
        await apiFetch('/api/servers/list', { timeoutMs: 3000 }).catch(()=>({}));
        scan();
      } catch (e) {
        showError(`Heads up: cannot reach ${Settings.base}. Set the correct API Base URL above and click "Test Connection".`);
      }
    })();
  </script>
</body>
</html>
